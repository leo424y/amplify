---
layout: post
title: 我不懂 Rails
---

## 我不懂 Rails

## 前言

「我不懂XX」是一個系列的學習記錄，在這個系列中我將記錄集中一段時內學習某一個東西的全記錄，並達到某一個特定的目標。「我不懂 Rails」是這個系列的第一部。如果你也有學習 Rails 方面的問題需要討論，有對我學習方向的建議和指導也可以發郵件與我討論，我的郵箱地址是 `mail@li-xinyang.com` 。如果你發現文中的知識點描述錯誤或者錯別字也歡迎提出 Pull Request 來修正，我會在第一時間將其合併。「我不懂 Rails」的 GitHub 倉庫可以在[這裡](https://github.com/li-xinyang/IDTK_Rails/tree/dev)找到。（[Ruby China](https://ruby-china.org/topics/31315) 同步更新）

## 筆者背景

[李忻陽](http://stackoverflow.com/cv/lixinyang)([li-xinyang](https://github.com/li-xinyang))，25歲，混蕩多年，鍾愛科技，喜歡設計。
2014年[經濟金融](https://www.rmit.edu.au/study-with-us/levels-of-study/undergraduate-study/bachelor-degrees/bp251)畢業，2015年[系統分析](https://www.iss.nus.edu.sg/graduate-programmes/programme/detail/graduate-diploma-in-systems-analysis)畢業生。
前端開發工作經驗一年半， SPA 開發（涉及 Backbone，D3.js，React.js），用戶界面設計，用戶交互實現。後端服務開發短暫接觸過 Java Spring， .NET，以及 Flask，有一定關係型（`SQL`）和文檔型（`MongoDB`）數據庫使用經驗，遠端平臺使用過 Digital Ocean 以及 Heroku 。

現在工作主要涉及的方面是快速原型開發和 API 實現。更多關於我開發學習經歷的內容可以在[這裡](http://udacity.li-xinyang.com/)找到。

## 學習目標

在眾多的網站開發框架中選擇 Rails 的理由是因為自己缺乏系統的網站開發的基礎和經驗，Rails 結合了網站開發中的最優開發流程和方式讓我不會遺漏任何需要注意到的細節。
我的目標是在一年內的時間可以找到一個和 Rails 相關的工作來獲得更多網絡開發的經驗。目標工作是 [Ruby Software Engineer (TradeGecko)](https://tradegecko.workable.com/jobs/192808) ，工作要求有有多年網絡開發經驗以及中級 Ruby 開發水平。

## 開始學習 Rails

在這個系列中我選擇了最新的 Rails 版本 `5.0.0.1` （發佈於 2016年8月）以及 `Ruby 2.3.1` 版本。在開始記錄學習 Rails 過程之前已經完成了一些 Ruby 相關基礎學習，其中包括 [Code School](https://www.codeschool.com/) 的 Ruby 以及 Rails 的基礎教程和 [Learning Ruby The Hard Way](https://learnrubythehardway.org/) 的閱讀和[練習](https://github.com/li-xinyang/FS_LearnRubyTheHardWay)。在接下來的整個學習 Rails 的過程中我不會強調操作系統，工具，相關知識也只會點到為止，更多的將著重與學習 Rails 的開發本身。

我所使用的全部資料都會給予出處，資料內容則不會在此記錄中重新複述，這樣可以保證任何時候瀏覽外部信息時都能夠保持最新的資料版本。這個系列中只會記錄我對於每一個知識點的理解和自己在理解知識點時所使用到的個別代碼實例。

### 第 001 天（20161008）

**閱讀 Rails 信條**

這是第三遍閱讀 [The Rails Doctrine](http://rubyonrails.org/doctrine/) （[中文 Rails 信條](https://ruby-china.org/wiki/the-rails-doctrine)），[David Heinemeier Hansson](https://en.wikipedia.org/wiki/David_Heinemeier_Hansson) 闡述了 Rails 與其他網站開發框架不同的地方和他對於網絡開發的理解。讀後依舊還是有很多地方看不懂。在後面得某一天再將篇信條看一遍。

**安裝 Ruby 環境**

我選擇使用 [rbenv](https://github.com/rbenv/rbenv) 來管理 Ruby 環境，只是因為它比 [rvm](https://github.com/rvm/rvm) 星星多，用起來簡單些，其餘的我不知道有何區別。rbenv 在 [macOS](https://en.wikipedia.org/wiki/Mac_OS) 上可以通過 [Homebrew](https://github.com/Homebrew/brew) 直接安裝。下面以 macOS 為例來安裝完全新的 Ruby 環境，

```
# 安裝 rbenv
brew install rbenv
# 安裝 Ruby 2.3.1
rbenv install 2.3.1
# 設置全局 Ruby 版本
rbenv global 2.3.1
# 查看當前 Ruby 使用源
which ruby
# -> /Users/li-xinyang/.rbenv/shims/ruby
# 查看當前 Ruby 版本
ruby --version
# -> ruby 2.3.1p112 (2016-04-26 revision 54768) [x86_64-darwin16]
```

rbenv 在不同系統下安裝以及使用方法可以在 rbenv 項目倉庫 [README](https://github.com/rbenv/rbenv#installation) 中找到。

**Rails 教程（Rails Guide）**

學習 Rails 開發除去相關書籍和教程外，官方框架教程是必讀的內容。因為它一定是最新最完整的涵蓋了 Rails 框架開發人員認為新手需要知道並正確使用該框架的各個方面的知識。

### 第 002 天（20161010）

在學習 Rails 的過程中社區推薦了很多書籍，在最後我選擇了 [Rails 4 in Action](https://www.safaribooksonline.com/library/view/rails-4-in/9781617291098/) 這本書，原因是 [Agile Web Development with Rails](https://pragprog.com/book/rails4/agile-web-development-with-rails-4) 時間有些久遠（最近已經[更新](https://pragprog.com/book/rails5/agile-web-development-with-rails-5)到 Rails 5 的版本），[Ruby On Rails Tutorial (Rails 5)](https://www.railstutorial.org/) 內容對有我來說有些碎鎖。Rails 4 in Action 可以讓我瞭解我整個 Rails 軟件的開發流程和過程中需要使用的相關技術。看這本書一週進程過半卻發現有些地方不清晰，所以現在重頭再過一次理解第一遍沒有看懂的地方。在完結這本書之後會回頭來看 Rails 官方指南和迅速過一遍 Agile Web Development with Rails 。這一次的代碼練習也將完全忽略樣式著重 Rails 軟件本身的開發，相關的 Gem 也不會過多的深究。

### 第 003 天（20161012）

學習 Rails 項目結構，理解初始後全部自動生成文件的功能。理解模型的簡單使用和校驗以及數據庫遷移的方法，明白 `resources` 的基礎含義。理解控制器和顯示層的關係，並熟悉常用 View Helper Method，如`form_for`，`form_tag`，`link_to`。學習簡單路由的映射。練習在不使用第三方 Gem 的情況下實現用戶註冊（不加密密碼）登陸登出功能（`Session` 的基礎使用方法）以及錯誤提示（`flash` 的基礎使用），這部分功能的實現在 Ruby On Rails Tutorial (Rails 5) [第八章](https://www.railstutorial.org/book/sign_up)和[第九章](https://www.railstutorial.org/book/advanced_login)有提及。

使用 [bcrypt](https://github.com/codahale/bcrypt-ruby) 替換掉明文密碼，並使用 [Capybara](https://github.com/jnicklas/capybara) 通過 [RSpec](https://github.com/rspec/rspec-rails) 添加 Acceptance Test （正常 [BDD](https://en.wikipedia.org/wiki/Behavior-driven_development) 的開發流程則應先完成需求測試後實現功能，之後的練習會使用正常 BDD 的方式來進行）。對於結合使用單元測試的方法現在還不清楚。

```
# Routes
Rails.application.routes.draw do
  root "sessions#new"

  resources :users

  get    'signin',      to: "sessions#new"
  post   'signin',      to: "sessions#create"
  delete 'signout',     to: "sessions#destroy", as: 'signout'

  get    'feed',        to: "feed#index"
end

# User Model
class User < ApplicationRecord
  validates :name, uniqueness: { case_sensitive: false }
  has_secure_password  # `gem 'bcrypt'` in Gemfile
end

# Users Controller
class UsersController < ApplicationController
  def new
    @user = User.new
  end

  def create
    @user = User.new(user_params)
    if @user.save
      flash[:notice] = "User has been created successfully."
      redirect_to feed_path
    else
      flash[:notice] = "User has not been created."
      render :new
    end
  end

  private
    def user_params
      params.require(:user).permit(:name, :password)
    end
end

# Sessions Controller
class SessionsController < ApplicationController
  def new
  end

  def create
    user = User.find_by(name: params[:name])
    if user.authenticate(params[:password])
      session[:user_id] = user.id
      redirect_to feed_path
    else
      flash[:notice] = "Invalid username/password"
      render :new
    end
  end

  def destroy
    session[:user_id] = nil
    flash[:notice] = "Successfuly sign out"
    redirect_to root_path
  end
end
```

```
<!-- New User Form -->
<%= form_for @user, url: users_path, method: :post do |form| %>
  <%= form.text_field :name %>
  <%= form.password_field :password %>
  <%= form.submit %>
<% end %>
```

```
<!-- Sign-in Form -->
<%= form_tag signin_path, method: :post do %>
  <%= text_field_tag :name %>
  <%= password_field_tag :password %>
  <%= submit_tag "Sign in" %>
<% end %>
```

使用 RSpec 替換默認 [minitest](https://github.com/seattlerb/minitest)，添加 Capybara Acceptance Test 並使用 [factory_girl_rails](https://github.com/thoughtbot/factory_girl) 生成測試數據。

```
# 執行下面的代碼如果需要默認使用 RSpec 而不是 minitest
rails g rspec:install
```

```
# DELETEME/spec/factories/user_factory.rb
# Factory Girl: User Factory
FactoryGirl.define do
  factory :user do
    name "SampleUser"
    password "SamplePassword"
  end
end

# DELETEME/spec/features/user_sign_in_spec.rb
# RSpec: Features Test
require 'rails_helper'

RSpec.feature 'User can sign in' do
  let!(:user) { FactoryGirl.create(:user) }

  scenario "with valid credentials" do
    visit root_path
    fill_in "name", with: user.name
    fill_in "password", with: user.password
    click_button "Sign in"

    expect(page).to have_content "Successfully sign in"
    expect(page).to have_content 'Feed'
    expect(page).to have_current_path(feed_path)
  end

  scenario "unless with invalid credentials" do
    visit root_path
    fill_in "name", with: user.name
    fill_in "password", with: ''
    click_button 'Sign in'

    expect(page).to have_content "Invalid username/password"
    expect(page).to have_current_path(signin_path)
  end
end
```

### 第 004 天（20161013）

理解 `before_action`， 它將會在 Rails 5 中完全[代替](https://github.com/rails/rails/commit/9d62e04838f01f5589fa50b0baa480d60c815e2c)舊的 [`before_filter`](https://github.com/rails/rails/blob/v5.0.0.beta2/actionpack/lib/abstract_controller/callbacks.rb#L190-L193)。瞭解學習 `ActionView` 中常用的幫助函數（Helper Methods）的存在和使用方法。`layout`，`view` 以及 `partial` 之間的關係和使用方法。

使用 [Guard](https://github.com/guard/guard) 來跑 RSpec 測試代碼，雖然還沒有弄清楚文件更改自動跑測試的規則（暫時使用 [guard-rspec](https://github.com/guard/guard-rspec)），一鍵跑全部的測試也比手動輸入測試命令要快許多。

學習基礎 `content_for` 與 `yield(:content_for_item)` 的使用方法。

Rails 4 in Action 中寫 Feature Test 樣例的方式有些奇怪不太符合正常的表達邏輯，所以昨天我將情景（scenario）做了一些修改。下面的代碼片段是書中的示例，

```
require "rails_helper"

RSpec.feature "Users can create new projects" do
  before do
    visit root_path
    click_link "New Project"
  end

  scenario "with valid attributes" do
    fill_in "Name", with: "New Project Name"
    fill_in "Description", with: "New project description"
    click_button "Create Project"

    expect(page).to have_content "Project has been created."
    expect(page).to have_content "New Project Name"
    expect(page).to have_content "New project description"

    project = Project.find_by(name: "New Project Name")
    expect(page.current_url).to eq project_url(project)
    expect(page).to have_title "New Project Name - Projects - Ticketee"
  end

  scenario "with providing invalid attributes" do
    fill_in "Name", with: ""
    fill_in "Description", with: ""
    click_button "Create Project"

    expect(page).to have_content "Project has not been created."
    expect(page).to have_content "Name can't be blank"
  end
end
```

輸出的結果為如下片段，

```
Failures:

  1) Users can create new projects with providing invalid attributes
```

看起來沒有邏輯的原因是 RSpec 將 Feature 與 Scenario 連在一起寫了，其正確的理解應該為在 “Users can create new projects” 功能下的 “with providing invalid attributes” 的情況。這裡需要查看更多成熟項目的 Cypabara 的 Feature Test 代碼來了解正確的使用方法。參考這篇來自 Throughtbot 的 [How We Test Rails Applications](https://robots.thoughtbot.com/how-we-test-rails-applications#feature-specs)（2014） 中的寫法 Feature 為一個功能而 Scenario 則應該為完整句子的獨立場景。那麼上面的輸出就應該是下面的樣子（我添加冒號讓兩個區域的關係更加明顯），

```
Failures:

  1) Users can create new projects: they use invalid attributes
```

這篇文章還同樣提到 Feature Test 不能完全替代單元測試，因為它慢所以更多測試應該在模塊對應的測試中完成。Rails 4 in Action 中暫時還沒有涉及到模型，視圖和控制器的測試這些測試方法和測試過程都會在之後的學習過程中被再次提及。兩本相關的書籍為 [Rails 4 Test Prescriptions](https://www.safaribooksonline.com/library/view/rails-4-test/9781680500493/) 和 [RSpec Essentials](https://www.safaribooksonline.com/library/view/rspec-essentials/9781784395902/) 。

控制器在保存模型實例時如果出現了錯誤，錯誤的信息會被保存到實例對象之中既 `@object_instance.errors` 中。

### 第 005 天（20161014）

添加 [Travis-CI](https://travis-ci.org/) 自動同步更新在 Ruby China 的同名主題。打算在掌握基礎 Rails 後學習 Ruby China 社區源碼。之後在文本中插入圖片也需要在將圖片上傳至[七牛 CDN](https://github.com/qiniu/ruby-sdk) 。

第四遍閱讀 [The Rails Doctrine](https://ruby-china.org/topics/31249)，這次的版本來自於 Ruby China 社區。其中提到了 [Flow: The Psychology of Optimal Experience](https://www.amazon.com/Flow-Harper-Perennial-Modern-Classics-ebook/dp/B000W94FE6) 這本書。感覺讀懂了百分之六十的樣子，下面是會心一笑的一段話。

> 在 Ruby 中，只要有好的理由沒有什麼可以阻止你用利器來掃除障礙。我們會通過約定、勸說和教育來推行好的理念，而不是通過禁止使用廚房中的利器，並堅持讓每個人使用勺子來切西紅柿。

### 第 006 天（20161015）

更新 Dash for macOS Capybara [Cheatsheet](https://github.com/Kapeli/cheatsheets/pull/243/files) 。

對於 `data: { confirm: "Sample text.." }` 不知道如何使用 JavaScript 生成更好看的確認方式代替瀏覽器原生的確認方式。迅速搜索了下解決辦法，[t4t5/sweetalert](https://github.com/t4t5/sweetalert) 一個代替原生確認的前端庫，[mois3x/sweet-alert-rails-confirm](https://github.com/mois3x/sweet-alert-rails-confirm) 是在前者基礎上用來在 Rails 中代替默認確認的 Gem 。另外一個類似於 sweetalert 的庫為 [Bootbox](http://bootboxjs.com/) 一個基於 Bootstrap 的前端確認庫。

[jquery-ujs](https://github.com/rails/jquery-ujs) 不是 jQuery UI ，它的作用是用來處理定製的 `data-` 屬性從而不使用鏈接的默認事件發起方式例如 `GET` 。

替換默認的確認的方式是複寫在 `jquery-ujs` 中的事件處理函數，如下所示（更多細節可以閱讀 [Custom dialog for data-confirm in Rails](http://thelazylog.com/custom-dialog-for-data-confirm-in-rails/) ）

```
$.rails.allowAction = function(link){
  if (link.data("confirm") == undefined){
    return true;
  }
  $.rails.showConfirmationDialog(link);
  return false;
}
```

建立新模型並添加兩個模型之間的關係（一個項目有多個工單），

```
rails g model project name:string description:string
rails g model ticket name:string description:string project:references
```

`project:references` 在 `ticket` 模型中定義 `project_id` 的外鍵並。

```
class CreateTickets < ActiveRecord::Migration[5.0]
  def change
    create_table :tickets do |t|
      t.string :name
      t.string :description
      t.references :project, foreign_key: true
      t.timestamps
    end
  end
end
```

Rails in Action 4 中用 [simple_form](https://github.com/plataformatec/simple_form) 來處理嵌套資源的表單生成，下面是不使用這個 Gem 來處理嵌套資源表單的方法，

```
<%= form_for [project, ticket] do |form| %>
  <%= form.text_field :name %>
  <%= form.text_field :description %>
  <%= form.submit "Create Ticket" %>
<% end %>
```

不知道是因該在 `before` 塊中使用 `FactoryGirl` 來創建測試數據還是應該是用 `let` 來創建測試數據。 `let` 創建一個和符號同樣名字的函數，每當函數被調用塊內的代碼就會被執行。

```
# lazy-loaded
let(:project) { FactoryGirl.create(:project) }
# evaluated immediately before test start
let!(:project) { FactoryGirl.create(:project) }
```

### 第 007 天（20161016）

今天學習通過 [devise](https://github.com/plataformatec/devise) 來添加授權功能和建立模型之間的關係。

```
# 初始化 Devise
rails g devise:install
# 創建 Devise 用戶模型
rails g devise user
# 創建 Devise 所使用的視圖
rails g devise:views
```

建立模型之間的關係，

```
class Ticket < ActiveRecord::Base
  belongs_to :project
  belongs_to :author, class_name: "User"
end

class User < ActiveRecord::Base
  has_many :ticket
end
```

創建模型之間關係的關鍵是創建數據庫遷移文件（添加外鍵和索引）。

```
class AddAuthorToTickets < ActiveRecord::Migration[5.0]
  def change
    add_reference :tickets, :author, index: true
    add_foreign_key :tickets, :users, column: :author_id
  end
end
```

### 第 008 天（20161017）

學習如何使用 RSpec 為控制器寫單元測試。

```
RSpec.describe Admin::ApplicationController, type: :controller do
  let(:user) { FactoryGirl.create(:user) }

  # 生成仿造用戶數據
  before do
    allow(controller).to receive(:current_user).and_return(user)
  end

  context 'non-admin users' do
    it 'are not able to access the index action' do
      get :index

      expect(response).to redirect_to '/'
      expect(flash[:alert]).to eq 'You must be an admin to do that.'
    end
  end
end
```
