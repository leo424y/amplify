---
layout: post
comments: true
title: Pundit
---

## [Pudit


              ](http://shaojunda-blog.logdown.com/posts/1088468-pudit)

### pundit 是干嘛的？

权限认证系统。比如，限制只有管理员才可以删帖子，HR 才可以查看员工的工资等等。

### 怎么安装？

1.  `gem "pundit"`。
2.   在 application controller 里引入 pundit。

    <figure class="figure-code code">
        <figcaption></figcaption>

        <pre data-original-code="class ApplicationController < ActionController::Base
        include Pundit
        protect_from_forgery with: :exception
        # other thing

        end
        " data-snippet-id="ext.b22f30e223c3bcfa6686da23ca82273e" data-snippet-saved="false" data-codota-status="done">
        classApplicationController < ActionController::Base
        include Pundit
        protect_from_forgery with: :exception
        \# other thing
        end
        </pre>
    </figure>

3.  `rails g pundit:install` 会生成 `app/policies/application_policy.rb` 文件，
    建议将所有的 police 文件都放在 app/policies 下。
4.  `rails g pundit:policy xxxx`

### 如何使用？

<!-- more -->

先看一个例子：

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="class ApplicationPolicy
      attr_reader :user, :record

      def initialize(user, record)
        @user = user
        @record = record
      end

      def index?
        false
      end

      def show?
        scope.where(:id => record.id).exists?
      end

      def create?
        false
      end

      def new?
        create?
      end

      def update?
        false
      end

      def edit?
        update?
      end

      def destroy?
        false
      end

      def scope
        Pundit.policy_scope!(user, record.class)
      end

      class Scope
        attr_reader :user, :scope

        def initialize(user, scope)
          @user = user
          @scope = scope
        end

        def resolve
          scope
        end
      end
    end

    " data-snippet-id="ext.bc141c87e9ab3736922026ed4ebedc59" data-snippet-saved="false" data-codota-status="done">
    class ApplicationPolicy
      attr_reader :user, :record

      def initialize(user, record)
        @user = user
        @record = record
      end

      def index?
        false
      end

      def show?
        scope.where(:id => record.id).exists?
      end

      def create?
        false
      end

      def new?
        create?
      end

      def update?
        false
      end

      def edit?
        update?
      end

      def destroy?
        false
      end

      def scope
        Pundit.policy_scope!(user, record.class)
      end

      class Scope
        attr_reader :user, :scope

        def initialize(user, scope)
          @user = user
          @scope = scope
        end

        def resolve
          scope
        end
      end
    end
    </pre>
</figure>

#### 基本概念

Pundit 默认会有以下几项假设：

* 所有的 policy 文件都只是普通的 class，这些 policy 的命名规则是需要验证的 model 的名字加上 Policy 后缀，
    比如对一个 Team model 进行验证的 policy 的名字应该是 TeamPolicy。

* Pundit 会调用 current_user 来获取 initialize 方法所需要的 user 参数。

* initialize 方法的第二个参数是要验证的 model 对象，这个参数不仅可以是 ActiveRecord 或 ActiveModel 也
    可以是任何类型的对象。

* 通常情况下 policy class 中会实现一些与 controller 同种 action 同名的方法，比如 `index?` `show?` `edit?` `update?` `add?` `crate?` `destroy?`。

我们可以新建 policy class 去继承 ApplicationPlicy。

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="class CommentPolicy < ApplicationPolicy
      def destroy?
        record.user == user
      end
    end
    " data-snippet-id="ext.7f410234c3b69ea6177487894432ea99" data-snippet-saved="false" data-codota-status="done">
    classCommentPolicy < ApplicationPolicy
      def destroy?
        record.user == user
      end
    end
    </pre>
</figure>

在 CommentsController 中这样使用：

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="def destroy
      authorize @comment
      @comment.destroy
      flash[:alert] = "成功删除这条评论"
      redirect_to team_project_todo_path(@team, @project, @todo)
    end
    " data-snippet-id="ext.ed94bb86f846ad9b4e196710bb200b1a" data-snippet-saved="false" data-codota-status="done">
    defdestroy
      authorize @comment
      @comment.destroy
      flash[:alert] = "成功删除这条评论"
      redirect_to team_project_todo_path(@team, @project, @todo)
    end
    </pre>
</figure>

authorize 方法会自动寻找并实例化所传递参数对应的 policy class 并运行对应的验证方法（默认调用与 action 同名的验证方法）验证失败会抛出异常。 在上述代码中，实例化了 CommentPolicy class 并将 `current_user` 和 `@comment` 传递到 CommentPolicy 中，最后调用了 CommentPolicy class 中的 `destroy?` 方法。

还可以通过向 authorize 传递第二个参数来指定调用哪个验证方法。

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="def destroy
      authorize @comment, :close?
      @comment.destroy
      flash[:alert] = "成功删除这条评论"
      redirect_to team_project_todo_path(@team, @project, @todo)
    end
    " data-snippet-id="ext.04bf0fb758a0c95d0f6b382e989f6cd7" data-snippet-saved="false" data-codota-status="done">
    def destroy
      authorize @comment, :close?
      @comment.destroy
      flash[:alert] = "成功删除这条评论"
      redirect_to team_project_todo_path(@team, @project, @todo)
    end
    </pre>
</figure>

在没有实例的情况下可以向 authorize 中传递 class。

Controller：

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="def admin_list
      authorize Post # we don't have a particular post to authorize

      # Rest of controller action

    end
    " data-snippet-id="ext.0d9e6793e687c81437c2174c218ccada" data-snippet-saved="false" data-codota-status="done">
    defadmin_list
      authorize Post \# we don't have a particular post to authorize
      \# Rest of controller action
    end
    </pre>
</figure>

在 view 和 controller 中可以通过 `policy` 方法来获得 policy 实例，这样可以在页面上根据不同权限来显示不同的元素，比如：

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="<% if policy(comment).destroy? %>
      <%= link_to("删除", team_project_todo_comment_path(team, project, todo, comment), class: "btn btn-sm btn-default", method: :delete, data: { confirm: "确定要删除这条任务吗？"}) %>
    <% end  %>
    " data-snippet-id="ext.b0ce3b9ded545df1ae9415a13311ff6b" data-snippet-saved="false" data-codota-status="done">
    <% if policy(comment).destroy? %>
      <%= link_to("删除", team_project_todo_comment_path(team, project, todo, comment), class: "btn btn-sm btn-default", method: :delete, data: { confirm: "确定要删除这条任务吗？"}) %>
    <% end  %>
    </pre>
</figure>

#### Scopes

我的理解就是可以根据不同的权限展示不同的结果集。

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="class TeamPolicy < ApplicationPolicy
      class Scope < Scope
        def resolve
          if user.id != 1
            scope
          else
            false
          end
        end
      end
    end
    " data-snippet-id="ext.10b5dba499dbbc5c44cfc5b04caec033" data-snippet-saved="false" data-codota-status="done">
    classTeamPolicy< ApplicationPolicy
      class Scope < Scope
        def resolve
          if user.id != 1
            scope
          else
            false
          end
        end
      end
    end
    </pre>
</figure>

Controller：

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="def index
      team_permissions = current_user.team_permissions.select("team_id")
      @teams = policy_scope(Team.includes(:user).where( id: team_permissions ).paginate(page: params[:page], per_page: 50))
    end
    " data-snippet-id="ext.6f07ea134c6dfb3ce45454caabea38ea" data-snippet-saved="false" data-codota-status="done">
    def indexteam_permissions = current_user.team_permissions.select("team_id")
      @teams = policy_scope(Team.includes(:user).where( id: team_permissions ).paginate(page: params[:page], per_page: 50))
    end
    </pre>
</figure>

View：

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="<% policy_scope(@teams).each do |team| %>
      <p><%= link_to team.name, team_path(team) %></p>
    <% end %>
    " data-snippet-id="ext.c65d39767b28cd268ec360383a7c573b" data-snippet-saved="false" data-codota-status="done">
    <% policy_scope(@teams).each do |team| %>
      <p><%= link_to team.name, team_path(team) %></p>
    <% end %>
    </pre>
</figure>

Pundit 默认会做以下假设：

* 在 policy class 中嵌套一个 Scope class。
* initialize 方法的第一个参数是 user。在 controller 中 Pundit 会使用 current_user。
* initialize 方法的第二个参数是传递进来的 scope，也可以是其他奇怪的东西。
* scope class 中有 resolve 方法，该方法会返回合适的结果集。

当调用 `policy_scope(xxx)` 时默认调用 resolve 方法，也可以手动指定 scope class 中的其他方法。

#### 异常处理

权限验证失败会抛出异常，可以在 ApplicationController 中使用 rescue_from 来处理异常：

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="class ApplicationController < ActionController::Base
      include Pundit
      protect_from_forgery with: :exception
      rescue_from Pundit::NotAuthorizedError, with: :user_not_authorized

      private

      def user_not_authorized
        flash[:alert] = "You are not authorized to perform this action."
        redirect_to(request.referrer || root_path)
      end
    end
    " data-snippet-id="ext.b8c4f5d6585e48fe5a3bb1915e0f69de" data-snippet-saved="false" data-codota-status="done">
    classApplicationController < ActionController::Base
      include Pundit
      protect_from_forgery with: :exception
      rescue_from Pundit::NotAuthorizedError, with: :user_not_authorized

      private

      def user_not_authorized
        flash[:alert] = "You are not authorized to perform this action."
        redirect_to(request.referrer || root_path)
      end
    end
    </pre>
</figure>

#### 手动调用

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="Pundit.policy!(user, post)
    Pundit.policy(user, post)

    Pundit.policy_scope!(user, Post)
    Pundit.policy_scope(user, Post)
    " data-snippet-id="ext.c7c669f549b001072c2f186a84fb6baf" data-snippet-saved="false" data-codota-status="done">
    Pundit.policy!(user, post)
    Pundit.policy(user, post)

    Pundit.policy_scope!(user, Post)
    Pundit.policy_scope(user, Post)
    </pre>
</figure>

如果调用的 policy 不存在加 ！方法会抛出异常，不加 ！ 的方法会返回 nil

#### 自定义 Pundit user

如果没有 current_user 方法，可以在 controller 中定义

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre>
    def pundit_user
      User.find_by_other_means
    end
    </pre>
</figure>

#### Strong parameters

通过在 policy class 中定义 permitted_attributes 方法来验证从前端传递到服务器对参数。

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="class TeamPolicy < ApplicationPolicy
      def permitted_attributes
        if user.admin? || user.owner_of?(record)
          [:name, :intro]
        else
          [:name]
        end
      end
    end
    " data-snippet-id="ext.a09ec3661045760517133c9ba8340772" data-snippet-saved="false" data-codota-status="done">
    classTeamPolicy < ApplicationPolicy
      def permitted_attributes
        if user.admin? || user.owner_of?(record)
          [:name, :intro]
        else
          [:name]
        end
      end
    end
    </pre>
</figure>

Controller：

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="class TeamsController < ApplicationController
      def update
        @team = Team.find(params[:id])
        if @team.update_attributes(team_params)
          redirect_to @team
        else
          render :edit
        end
      end

      private

      def team_params
        params.require(:team).permit(policy(@team).permitted_attributes)
      end
    end
    " data-snippet-id="ext.9bc7f305e9eed1a93490402414ef16a2" data-snippet-saved="false" data-codota-status="done">
    classTeamsController <ApplicationController
      def update
        @team = Team.find(params[:id])
        if @team.update_attributes(team_params)
          redirect_to @team
        else
          render :edit
        end
      end

      private

      def team_params
        params.require(:team).permit(policy(@team).permitted_attributes)
      end
    end
    </pre>
</figure>

还可以为通过 permitted_attributes_for_#{action} 方法来为每一个 action 指定不同的参数验证方法。

<figure class="figure-code code">
    <figcaption></figcaption>

    <pre data-original-code="class TeamPolicy < ApplicationPolicy
      def permitted_attributes_for_create
        [:title, :body]
      end

      def permitted_attributes_for_edit
        [:body]
      end
    end
    " data-snippet-id="ext.fd8522f88178a95767a87e74dd93f04e" data-snippet-saved="false" data-codota-status="done">
    classTeamPolicy < ApplicationPolicy
      def permitted_attributes_for_create
        [:title, :body]
      end

      def permitted_attributes_for_edit
        [:body]
      end
    end
    </pre>
</figure>

更多细节去看官方文档吧： [Pundit](https://github.com/elabs/pundit "Pundit")

[myblog](https://shaojunda.github.io/2016/11/09/pundit/)

