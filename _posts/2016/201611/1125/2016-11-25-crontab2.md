---
layout: post
comments: true
title: crontab
---

col 1
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<pre data-original-code="[root@study ~]# crontab [-u username] [-l|-e|-r]
選項與參數：
-u  ：只有 root 才能進行這個任務，亦即幫其他使用者建立/移除 crontab 工作排程；
-e  ：編輯 crontab 的工作內容
-l  ：查閱 crontab 的工作內容
-r  ：移除所有的 crontab 的工作內容，若僅要移除一項，請用 -e 去編輯。

範例一：用 dmtsai 的身份在每天的 12:00 發信給自己
[dmtsai@study ~]$ crontab -e
# 此時會進入 vi 的編輯畫面讓您編輯工作！注意到，每項工作都是一行。
0   12  *  *  * mail -s "at 12:00" dmtsai < /home/dmtsai/.bashrc
#分 時 日 月 週 |<==============指令串========================>|
" data-snippet-id="ext.c9107f6b34c3a2b456c1db84c2a72905" data-snippet-saved="false" data-codota-status="done">
[root@study ~]# crontab [-u username] [-l|-e|-r]
選項與參數：
-u  ：只有 root 才能進行這個任務，亦即幫其他使用者建立/移除 crontab 工作排程；
-e  ：編輯 crontab 的工作內容
-l  ：查閱 crontab 的工作內容
-r  ：移除所有的 crontab 的工作內容，若僅要移除一項，請用 -e 去編輯。

範例一：用 dmtsai 的身份在每天的 12:00 發信給自己
[dmtsai@study ~]$ crontab -e
\# 此時會進入 vi 的編輯畫面讓您編輯工作！注意到，每項工作都是一行。
0   12  *  *  * mail -s "at 12:00" dmtsai < /home/dmtsai/.bashrc
\#分 時 日 月 週 |<==============指令串========================>|
</pre>

預設情況下，任何使用者只要不被列入 /etc/cron.deny 當中，那麼他就可以直接下達『 crontab -e』去編輯自己的例行性命令了！整個過程就如同上面提到的，會進入 vi 的編輯畫面，
然後以一個工作一行來編輯，編輯完畢之後輸入『 :wq 』儲存後離開 vi 就可以了！
而每項工作 (每行) 的格式都是具有六個欄位，這六個欄位的意義為：

col 1 | col 2 | col 3 | col 4 | col 5 | col 6 | col 7
----- | ----- | ----- | ----- | ----- | ----- | -----
代表意義  | 分鐘    | 小時    | 日期    | 月份    | 週     | 指令
數字範圍  | 0-59  | 0-23  | 1-31  | 1-12  | 0-7   | 呀就指令啊

比較有趣的是那個『週』喔！週的數字為 0 或 7 時，都代表『星期天』的意思！另外，還有一些輔助的字符，大概有底下這些：

col 1  | col 2
------ | ------------------------------------------------------------------------------------------------------------------
特殊字符   | 代表意義
\*(星號) | 代表任何時刻都接受的意思！舉例來說，範例一內那個日、月、週都是 * ，
	就代表著『不論何月、何日的禮拜幾的 12:00 都執行後續指令』的意思！
,(逗號)  | 代表分隔時段的意思。舉例來說，如果要下達的工作是 3:00 與 6:00 時，就會是：

> 0 3,6 * * * command
	時間參數還是有五欄，不過第二欄是 3,6 ，代表 3 與 6 都適用！
-(減號)  | 代表一段時間範圍內，舉例來說， 8 點到 12 點之間的每小時的 20 分都進行一項工作：

> 20 8-12 * * * command
	仔細看到第二欄變成 8-12 喔！代表 8,9,10,11,12 都適用的意思！
/n(斜線) | 那個 n 代表數字，亦即是『每隔 n 單位間隔』的意思，例如每五分鐘進行一次，則：

> \*/5 * * * * command
	很簡單吧！用 * 與 /5 來搭配，也可以寫成 0-59/5 ，相同意思！

我們就來搭配幾個例子練習看看吧！底下的案例請實際用 dmtsai
這個身份作看看喔！後續的動作才能夠搭配起來！

col 1
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
例題：

假若你的女朋友生日是 5 月 2 日，你想要在 5 月 1 日的 23:59 發一封信給他，這封信的內容已經寫在
/home/dmtsai/lover.txt 內了，該如何進行？
答：

直接下達 crontab -e 之後，編輯成為：

> 59 23 1 5  *  mail kiki < /home/dmtsai/lover.txt
那樣的話，每年 kiki 都會收到你的這封信喔！（當然囉，信的內容就要每年變一變啦！）

col 1
-------------------------------------------------------------------------------------------------------------
例題：

假如每五分鐘需要執行  /home/dmtsai/test.sh 一次，又該如何？
答：

同樣使用 crontab -e 進入編輯：

> \*/5 * * * * /home/dmtsai/test.sh

那個 crontab 每個人都只有一個檔案存在，就是在 /var/spool/cron 裡面啊！
還有建議您：『指令下達時，最好使用絕對路徑，這樣比較不會找不到執行檔喔！』

col 1
--------------------------------------------------------------------------------------------------------------------------------------------------
例題：

假如你每星期六都與朋友有約，那麼想要每個星期五下午 4:30 告訴你朋友星期六的約會不要忘記，則：
答：

還是使用 crontab -e 啊！

> 30 16 * * 5 mail friend@his.server.name < /home/dmtsai/friend.txt

真的是很簡單吧！呵呵！那麼，該如何查詢使用者目前的 crontab 內容呢？我們可以這樣來看看：

col 1
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<pre data-original-code="[dmtsai@study ~]$ crontab -l
0 12 * * * mail -s "at 12:00" dmtsai < /home/dmtsai/.bashrc
59 23 1 5 * mail kiki < /home/dmtsai/lover.txt
*/5 * * * * /home/dmtsai/test.sh
30 16 * * 5 mail friend@his.server.name < /home/dmtsai/friend.txt

# 注意，若僅想要移除一項工作而已的話，必須要用 crontab -e 去編輯～
# 如果想要全部的工作都移除，才使用 crontab -r 喔！
[dmtsai@study ~]$ crontab -r
[dmtsai@study ~]$ crontab -l
no crontab for dmtsai
" data-snippet-id="ext.128a8027ca4aeda548aab53475129b09" data-snippet-saved="false" data-codota-status="done">
[dmtsai@study ~]$ crontab -l
0 12 * * * mail -s "at 12:00" dmtsai < /home/dmtsai/.bashrc
59 23 1 5 * mail kiki < /home/dmtsai/lover.txt
*/5 * * * * /home/dmtsai/test.sh
30 16 * * 5 mail friend@his.server.name < /home/dmtsai/friend.txt

\# 注意，若僅想要移除一項工作而已的話，必須要用 crontab -e 去編輯～
\# 如果想要全部的工作都移除，才使用 crontab -r 喔！
[dmtsai@study ~]$ crontab -r
[dmtsai@study ~]$ crontab -l
no crontab for dmtsai
</pre>

看到了嗎？ crontab 『整個內容都不見了！』所以請注意：『如果只是要刪除某個 crontab 的工作項目，那麼請使用 crontab -e 來重新編輯即可！』如果使用 -r 的參數，是會將所有的
crontab 資料內容都刪掉的！千萬注意了！


[Top](http://linux.vbird.org/linux_basic/0430cron.php#top)

## 15.3.2 系統的設定檔： /etc/crontab, /etc/cron.d/*

這個『 crontab -e 』是針對使用者的 cron 來設計的，如果是『系統的例行性任務』時，
該怎麼辦呢？是否還是需要以 crontab -e 來管理你的例行性工作排程呢？當然不需要，你只要編輯
/etc/crontab 這個檔案就可以啦！有一點需要特別注意喔！那就是
crontab -e 這個 crontab 其實是 /usr/bin/crontab 這個執行檔，但是 /etc/crontab
可是一個『純文字檔』喔！你可以 root 的身份編輯一下這個檔案哩！

基本上， cron 這個服務的最低偵測限制是『分鐘』，所以『 cron
會每分鐘去讀取一次 /etc/crontab 與 /var/spool/cron 裡面的資料內容
』，因此，只要你編輯完 /etc/crontab 這個檔案，並且將他儲存之後，那麼
cron 的設定就自動的會來執行了！

<fieldset class="vbirdface">
    <legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend>![鳥哥的圖示](http://linux.vbird.org/images/vbird_face.gif "鳥哥的圖示")		在 Linux 底下的 crontab 會自動的幫我們每分鐘重新讀取一次 /etc/crontab
    		的例行工作事項，但是某些原因或者是其他的 Unix 系統中，由於 crontab
    		是讀到記憶體當中的，所以在你修改完 /etc/crontab 之後，可能並不會馬上執行，
    		這個時候請重新啟動 crond 這個服務吧！『systemctl restart crond』

</fieldset>


廢話少說，我們就來看一下這個 /etc/crontab 的內容吧！

col 1
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<pre data-original-code="[root@study ~]# cat /etc/crontab
SHELL=/bin/bash                     <==使用哪種 shell 介面
PATH=/sbin:/bin:/usr/sbin:/usr/bin  <==執行檔搜尋路徑
MAILTO=root                         <==若有額外STDOUT，以 email將資料送給誰

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed
" data-snippet-id="ext.058a9382525427b6501384ef972939d6" data-snippet-saved="false" data-codota-status="done">
[root@study ~]# cat /etc/crontab
SHELL=/bin/bash                     <==使用哪種 shell 介面
PATH=/sbin:/bin:/usr/sbin:/usr/bin  <==執行檔搜尋路徑
MAILTO=root                         <==若有額外STDOUT，以 email將資料送給誰

# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed
</pre>

看到這個檔案的內容你大概就瞭解了吧！呵呵，沒錯！這個檔案與將剛剛我們下達 crontab -e 的內容幾乎完全一模一樣！只是有幾個地方不太相同：

* MAILTO=root：

這個項目是說，當 /etc/crontab 這個檔案中的例行性工作的指令發生錯誤時，或者是該工作的執行結果有
STDOUT/STDERR 時，會將錯誤訊息或者是螢幕顯示的訊息傳給誰？預設當然是由系統直接寄發一封 mail 給 root 啦！不過，
由於 root 並無法在用戶端中以 POP3 之類的軟體收信，因此，鳥哥通常都將這個 e-mail
改成自己的帳號，好讓我隨時瞭解系統的狀況！例如：
MAILTO=dmtsai@my.host.name

* PATH=....：

還記得我們在[第十章的 BASH](http://linux.vbird.org/linux_basic/0320bash.php#env) 當中一直提到的執行檔路徑問題吧！
沒錯啦！這裡就是輸入執行檔的搜尋路徑！使用預設的路徑設定就已經很足夠了！

* 『分 時 日 月 周 身份 指令』七個欄位的設定

這個 /etc/crontab 裡面可以設定的基本語法與 crontab -e 不太相同喔！前面同樣是分、時、日、月、周五個欄位，
但是在五個欄位後面接的並不是指令，而是一個新的欄位，那就是『執行後面那串指令的身份』為何！這與使用者的 crontab -e 不相同。由於使用者自己的
crontab 並不需要指定身份，但 /etc/crontab 裡面當然要指定身份啦！以上表的內容來說，系統預設的例行性工作是以 root
的身份來進行的。

* crond 服務讀取設定檔的位置

一般來說，crond 預設有三個地方會有執行腳本設定檔，他們分別是：

* /etc/crontab
* /etc/cron.d/*
* /var/spool/cron/*

這三個地方中，跟系統的運作比較有關係的兩個設定檔是放在 /etc/crontab 檔案內以及 /etc/cron.d/* 目錄內的檔案，
另外一個是跟用戶自己的工作比較有關的設定檔，就是放在 /var/spool/cron/ 裡面的檔案群。
現在我們已經知道了 /var/spool/cron 以及 /etc/crontab 的內容，那現在來瞧瞧 /etc/cron.d 裡面的東西吧！

col 1
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
<pre data-original-code="[root@study ~]# ls -l /etc/cron.d
-rw-r--r--. 1 root root 128 Jul 30  2014 0hourly
-rw-r--r--. 1 root root 108 Mar  6 10:12 raid-check
-rw-------. 1 root root 235 Mar  6 13:45 sysstat
-rw-r--r--. 1 root root 187 Jan 28  2014 unbound-anchor
# 其實說真的，除了 /etc/crontab 之外，crond 的設定檔還不少耶！上面就有四個設定！
# 先讓我們來瞧瞧 0hourly 這個設定檔的內容吧！

[root@study ~]# cat /etc/cron.d/0hourly
# Run the hourly jobs
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
01 * * * * root run-parts /etc/cron.hourly
# 瞧一瞧，內容跟 /etc/crontab 幾乎一模一樣！但實際上是有設定值喔！就是最後一行！
" data-snippet-id="ext.af3e2451ee05036fbafaaa47570783a1" data-snippet-saved="false" data-codota-status="done">
[root@study ~]# ls -l /etc/cron.d
-rw-r--r--. 1 root root 128 Jul 30  2014 0hourly
-rw-r--r--. 1 root root 108 Mar  6 10:12 raid-check
-rw-------. 1 root root 235 Mar  6 13:45 sysstat
-rw-r--r--. 1 root root 187 Jan 28  2014 unbound-anchor
\# 其實說真的，除了 /etc/crontab 之外，crond 的設定檔還不少耶！上面就有四個設定！
\# 先讓我們來瞧瞧 0hourly 這個設定檔的內容吧！

[root@study ~]# cat /etc/cron.d/0hourly
# Run the hourly jobs
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
01 * * * * root run-parts /etc/cron.hourly
\# 瞧一瞧，內容跟 /etc/crontab 幾乎一模一樣！但實際上是有設定值喔！就是最後一行！
</pre>

如果你想要自己開發新的軟體，該軟體要擁有自己的 crontab 定時指令時，就可以將『分、時、日、月、周、身份、指令』的設定檔放置到 /etc/cron.d/ 目錄下！
在此目錄下的檔案是『crontab 的設定檔腳本』。

<fieldset class="vbirdface">
    <legend style="font-family: serif; font-size:12pt; color: darkblue;">Tips</legend>![鳥哥的圖示](http://linux.vbird.org/images/vbird_face.gif "鳥哥的圖示")		以鳥哥來說，現在鳥哥有在開發一些虛擬化教室的軟體，該軟體需要定時清除一些垃圾防火牆規則，
    		那鳥哥就是將要執行的時間與指令設計好，然後直接將設定寫入到 /etc/cron.d/newfile 即可！未來如果這個軟體要升級，
    		直接將該檔案覆蓋成新檔案即可！比起手動去分析 /etc/crontab 要單純的多！

</fieldset>

另外，請注意一下上面表格中提到的最後一行，每個整點的一分會執行『 run-parts /etc/cron.hourly 』這個指令～咦！那什麼是 run-parts 呢？
如果你有去分析一下這個執行檔，會發現他就是 shell script，run-parts 腳本會在大約 5 分鐘內隨機選一個時間來執行
/etc/cron.hourly 目錄內的所有執行檔！因此，放在 /etc/cron.hourly/ 的檔案，必須是能被直接執行的指令腳本，
而不是分、時、日、月、周的設定值喔！注意注意！

也就是說，除了自己指定分、時、日、月、周加上指令路徑的 crond 設定檔之外，你也可以直接將指令放置到(或連結到)/etc/cron.hourly/ 目錄下，
則該指令就會被 crond 在每小時的 1 分開始後的 5 分鐘內，隨機取一個時間點來執行囉！你無須手動去指定分、時、日、月、周就是了。

但是眼尖的朋友可能還會發現，除了可以直接將指令放到 /etc/cron.hourly/ 讓系統每小時定時執行之外，在 /etc/ 底下其實還有
/etc/cron.daily/, /etc/cron.weekly/, /etc/cron.monthly/，那三個目錄是代表每日、每週、每月各執行一次的意思嗎？嘿嘿！
厲害喔！沒錯～是這樣～不過，跟 /etc/cron.hourly/ 不太一樣的是，那三個目錄是由 anacron 所執行的，而 anacron 的執行方式則是放在
/etc/cron.hourly/0anacron 裡面耶～跟前幾代 anacron 是單獨的 service 不太一樣喔！這部份留待下個小節再來討論。

最後，讓我們總結一下吧：

* 個人化的行為使用『 crontab -e 』：如果你是依據個人需求來建立的例行工作排程，建議直接使用 crontab -e 來建立你的工作排程較佳！
    		這樣也能保障你的指令行為不會被大家看到 (/etc/crontab 是大家都能讀取的權限喔！)；
* 系統維護管理使用『 vim /etc/crontab 』：如果你這個例行工作排程是系統的重要工作，為了讓自己管理方便，同時容易追蹤，建議直接寫入 /etc/crontab 較佳！
* 自己開發軟體使用『 vim /etc/cron.d/newfile 』：如果你是想要自己開發軟體，那當然最好就是使用全新的設定檔，並且放置於 /etc/cron.d/ 目錄內即可。
* 固定每小時、每日、每週、每天執行的特別工作：如果與系統維護有關，還是建議放置到 /etc/crontab 中來集中管理較好。
    		如果想要偷懶，或者是一定要再某個週期內進行的任務，也可以放置到上面談到的幾個目錄中，直接寫入指令即可！

