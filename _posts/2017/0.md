Rails: 用 array 搜尋 model

# 法一

```
Model.where('id IN (?)', [array of values])
```

# 法二
```
Model.where(id: [array of values])
```
;
Rails: 用 increment 改變 model 欄位數值

You can use several ways to update the value:

with validation:

```
refund_update.increment('price', 5)
```

or

```
refund_update.update_attributes({'price': refund_update.price+5})
```

without validation:

```
refund_update.increment!('price',5)
```

or

```
refund_update.update_attribute('price', refund_update.price+5)
```
;
Rails 數值位數設定。全部金錢通通對齊啦！看走眼的要罰錢！

設 local 的話會雞婆地幫你上該幣的符號(unit)，寫個helper用空字串來取代它吧

```
number_to_currency(money, precision: 2, unit: '')
```

You should use `number_with_precision` helper. [See doc](http://api.rubyonrails.org/classes/ActionView/Helpers/NumberHelper.html#method-i-number_with_precision).

Example:

```
number_with_precision(1.5, :precision => 2)
=> 1.50
```

Within you form helper:

```
<%= f.text_field :cost, :class => 'cost', :value => (number_with_precision(f.object.cost, :precision => 2) || 0) %>
```

BTW, if you really want to display some price, use `number_to_currency`, same page for doc (In a form context, I'd keep `number_with_precision`, you don't want to mess up with money symbols)

;
Rails: find_by_id 只要用 find 即可啦！才怪

# 有點不一樣

`Model.find()` can accept array of ids, and will return all records which matches.
`Model.find_by_id(123)` also accept array but will only process first id value present in array

```
Model.find([1,2,3]) # find 給你全部
Model.find_by_id([1,2,3]) # find_by 只給你第一個
```

Use whichever one you feel suits your needs best.

# 源碼
**where** returns ActiveRecord::Relation

Now take a look at find_by implementation:

```
def find_by
  where(*args).take
end
```

As you can see **find_by** is the same as **where** but it returns only one record. This method should be used for getting 1 record and **where** should be used for getting all records with some conditions.

# find 用 id 來找
The `find` method is usually used to retrieve a row by ID:

```
Model.find(1)
```

Other uses of `find` are usually replaced with things like this:

```
Model.all
Model.first
```

`Find_by` is used as a helper when you're searching for information within a column, and it maps to such with naming conventions.  For instance, if you have a column named `name` in your database, you'd use the following syntax:

```
Model.find_by_name("Bob")
```

However, I believe `find_by` is being deprecated.

`.where` is more of a catch all that lets you use a bit more complex logic for when the conventional helpers won't do.

# where 不是一開始就是 where

```
https://github.com/rails/activerecord-deprecated_finders
```

x哥覺得 xxxx
;
Rails: 取得所有 Model 的名字，出乎易料地簡單

大神們都幫我們準備好啦

# 解答
For **Rails5** models [are now subclasses](http://blog.bigbinary.com/2015/12/28/application-record-in-rails-5.html) of `ApplicationRecord` so to get list of all models in your app you do:

```
ApplicationRecord.descendants.collect { |type| type.name }
```

Or shorter:

```
ApplicationRecord.descendants.collect(&:name)
```

If you are in dev mode, you will need to eager load models before:

```
Rails.application.eager_load!
```

# 注意不同開發環境的設定

The whole answer for Rails 3, 4 and 5 is:

If `cache_classes` is off (by default it's off in development, but on in production):

```
Rails.application.eager_load!
```

Then:

```
ActiveRecord::Base.descendants
```

This makes sure all models in your application, regardless of where they are, are loaded, and any gems you are using which provide models are also loaded.

This should also work on classes that inherit from `ActiveRecord::Base`, like `ApplicationRecord` in Rails 5, and return only that subtree of descendants:

```
ApplicationRecord.descendants
```

If you'd like to know more about _how_ this is done, check out [ActiveSupport::DescendantsTracker](http://api.rubyonrails.org/classes/ActiveSupport/DescendantsTracker.html).

;
取得 url 傳來的 json

You can use jQuery [`.getJSON()`](http://api.jquery.com/jQuery.getJSON/) function:

```
$.getJSON('http://query.yahooapis.com/v1/public/yql?q=select%20%2a%20from%20yahoo.finance.quotes%20WHERE%20symbol%3D%27WRC%27&format=json&diagnostics=true&env=store://datatables.org/alltableswithkeys&callback', function(data) {
    //data is the JSON string
});
```

If you don't want to use jQuery you should look at this answer for pure JS solution: https://stackoverflow.com/a/2499647/1361042

;
Rails: to_json



```
require 'erb'
require 'json'

h = Hash.new
h["first"] = "First"
h["second"] = "Second"

template = ERB.new <<-EOF
  {
    "key": "value",
    "foo": 1,
    "Hash": <%= h.to_json %>,
    "bar": 2
  }
EOF

puts template.result(binding)
```

**output**

```
[arup@Ruby]$ ruby a.rb
  {
    "key": "value",
    "foo": 1,
    "Hash": {"first":"First","second":"Second"},
    "bar": 2
  }
[arup@Ruby]$
```

;
自己的current_user自己刻

### Rails 5

**Declare a module**

```
module Current
  thread_mattr_accessor :user
end
```

**Assign the current user**

```
class ApplicationController < ActionController::Base
  around_action :set_current_user
  def set_current_user
    Current.user = current_user
    yield
  ensure
    # to address the thread variable leak issues in Puma/Thin webserver
    Current.user = nil
  end
end
```

Now you can refer to the current user as `Current.user`

Documentation about [thread_mattr_accessor](http://blog.bigbinary.com/2016/09/05/rails-5-adds-ability-to-create-module-and-class-level-variables-on-per-thread-basis.html?utm_source=rubyweekly&utm_medium=email)

### Rails 3,4

It is not a common practice to access the `current_user` within a model. That being said, here is a solution:

```
class User < ActiveRecord::Base
  def self.current
    Thread.current[:current_user]
  end

  def self.current=(usr)
    Thread.current[:current_user] = usr
  end
end
```

Set the `current_user` attribute in a `around_filter` of `ApplicationController`.

```
class ApplicationController < ActionController::Base
  around_filter :set_current_user

  def set_current_user
    User.current = User.find_by_id(session[:user_id])
    yield
  ensure
    # to address the thread variable leak issues in Puma/Thin webserver
    User.current = nil
  end
end
```

Set the `current_user` after successful authentication:

```
def login
  if User.current=User.authenticate(params[:username], params[:password])
    session[:user_id] = User.current.id
    flash[:message] = "Successfully logged in "
    redirect_to( :action=>'home')
  else
    flash[:notice] = "Incorrect user/password combination"
    redirect_to(:action=>"login")
  end
end
```

Finally, refer to the `current_user` in `update_history` of `Item`.

```
class Item < ActiveRecord::Base
  has_many :histories
  after_create :update_history
  def update_history
    histories.create(:date=>Time.now, :username=> User.current.username)
  end
end
```

;
Rails: 不在。不在

I'm using this:

```
Topic.where('id NOT IN (?)',actions)
```

Where `actions` is an array with: `[1,2,3,4,5]`

Edit:

For Rails 4 notation:

```
Article.where.not(title: ['Rails 3', 'Rails 5'])
```

;
0715 還沒看完的連結們

* [程式設計師的履歷撰寫要點 | Just for noting](https://blog.m157q.tw/posts/2016/01/22/how-to-write-a-resume-for-programming-jobs/)
* [Ruby Jobs, Employment | Indeed.com](https://www.indeed.com/q-Ruby-jobs.html)
* [Freelance Ruby On Rails Jobs Online - Upwork](https://www.upwork.com/o/jobs/browse/skill/ruby-on-rails/)
* [Lingceng's Blog](http://blog.lingceng.io/)
* [SQL好文分享 - 十步完全理解 SQL « 進擊的程式新手](http://malagege.logdown.com/posts/2031985-sql-fine-literature-ten-steps-to-fully-understand-the-sql)
* [[g0v 公民科技創新獎助金] [獎助金一般討論/最新消息] 徵件主題相關專案介紹 - leo424y@gmail.com - Gmail](https://mail.google.com/mail/u/0/#inbox/15d3aa31f555afe7)

;
